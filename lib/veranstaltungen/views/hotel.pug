extends ../../../views/layout
include ../../../views/formComponents
include kontakt


mixin zimmerNumEUR(name, label)
  .col-sm-4
    .row
      .col-6
        +number('unterkunft[' + name + 'Num]', label, unterkunft[name + 'Num'](), null, '0', '80')
      .col-6
        +currency('unterkunft[' + name + 'EUR]', 'Preis', unterkunft[name + 'EUR']())


block title
  | Veranstaltung

block content
  -var unterkunft = veranstaltung.unterkunft()
  .col-12
    form#hotelform(action='/veranstaltungen/submit', method='post')
      +csrf
      +hidden('id', veranstaltung.id())
      +hidden('kopf[confirmed]', veranstaltung.kopf().confirmed() ? 'on' : undefined)
      fieldset
        .row
          .col-12
            .page-header
              +submitButtonsFor(veranstaltung, 'hotel')
              h2 Hotel für #{veranstaltung.datumForDisplay()}<br>
                small #{veranstaltung.kopf().titel()} #{veranstaltung.kopf().presseIn()}
        .row
          .col-12
            .btn-group
              a.btn.btn-light(href=veranstaltung.fullyQualifiedUrl() + '/hotelMail/reminder', title='Erinnerung')
                i.fas.fa-envelope.fa-fw.fa-lg
                | &nbsp;Infomail an #{hotelMailReceiver}
              a.btn.btn-light(href=veranstaltung.fullyQualifiedUrl() + '/hotelMail/preview', title='Vorschau')
                i.fas.fa-envelope.fa-fw.fa-lg
                | &nbsp;Reservierungsvorschau an mich
              a.btn.btn-primary(href=veranstaltung.fullyQualifiedUrl() + '/hotelMail/reservation', title='Reservierung')
                i.far.fa-envelope.fa-fw.fa-lg
                | &nbsp;Reservierung an Hotel
        .row
          .col-md-6
            +kontakt(veranstaltung, optionen.hotels(), 'Hotel', 'hotel', 'color-hotel')
            +legendMitBody('zimmer', 'Zimmer', 'roomsTotal', 'color-hotel')
              .row
                .col-4()
                  +date('unterkunft[anreiseDate]', 'Anreise', unterkunft.anreiseDisplayDate(), 'Diese Werte haben Einfluß auf den berechneten Preis', unterkunft.minimalStartForHotel())
                  +date('unterkunft[abreiseDate]', 'Abreise', unterkunft.abreiseDisplayDate(), null, unterkunft.minimalStartForHotel())
                  label
                    span#naechte 0
                    span #{''} Nächte
                .col-8()
                  +textareaPure('unterkunft[kommentar]', 'Kommentar', unterkunft.kommentar(), 'Name der Gäste')
              .row
                +zimmerNumEUR('einzel', 'Einzel')
                +zimmerNumEUR('doppel', 'Doppel')
                +zimmerNumEUR('suite', 'Suite')
              .row
                .col-12
                  +checkbox('hotelpreise', 'Preise als Default übernehmen')
              .row
                for step in unterkunft.workflow()
                  .col-6
                    .checkbox.abc-checkbox.abc-checkbox-success(style='margin-top: 0; margin-bottom: 0;')
                      input.hotelstep(type='checkbox', id=step, name=step, checked=unterkunft.isChecked(step))
                      label(for=step)
                        | #{step}
              
          .col-md-6
            +legendMitBody('transport', 'Transport', 'transportTotal', 'color-hotel')
              +textareaPure('unterkunft[transportText]', 'Anmerkungen', unterkunft.transportText(), 'Wer, wann, wo abholen, hinbringen?')
              .row
                .col-md-6
                  +multiselect('unterkunft[sonstiges]', 'Bus / Sonstiges', unterkunft.sonstiges(), ['Parkgenehmigung', 'Stromanschluss'])
                .col-md-6
                  +currency('unterkunft[transportEUR]', 'Summe', unterkunft.transportEUR())
        .row
          .col-12
            hr
            +submitButtonsFor(veranstaltung, 'hotel')
block scripts
  +kontaktScript('hotel', 'hotelchanged')
  script.
    var updatePreise;
    function hotelchanged(auswahl) {
      $.ajax('/optionen/preiseForAuswahl', {data: {auswahl: auswahl}})
       .done(function (result) {
         if (result) {
           updatePreise(result);
         }
       })
    }

    $(document).ready(function() {
      var einzelEUR = $('#unterkunft\\[einzelEUR\\]');
      var einzelNum = $('#unterkunft\\[einzelNum\\]');
      var doppelEUR = $('#unterkunft\\[doppelEUR\\]');
      var doppelNum = $('#unterkunft\\[doppelNum\\]');
      var suiteEUR = $('#unterkunft\\[suiteEUR\\]');
      var suiteNum = $('#unterkunft\\[suiteNum\\]');
      var startDateField = $('#unterkunft\\[anreiseDate\\]');
      var endDateField = $('#unterkunft\\[abreiseDate\\]');

      updatePreise = function(preise) {
        setEuro(einzelEUR, preise.einzelEUR);
        setEuro(doppelEUR, preise.doppelEUR);
        setEuro(suiteEUR, preise.suiteEUR);
      }
      
      function updateRoomsTotal() {
        var startDate = startDateField.datepicker('getDate');
        var endDate = endDateField.datepicker('getDate');
        var days = startDate && endDate ? moment(endDate).diff(startDate, 'days') : 0;
        
        var total = eurAmount(einzelEUR) * intAmount(einzelNum) * days 
          + eurAmount(doppelEUR) * intAmount(doppelNum) * days
          + eurAmount(suiteEUR) * intAmount(suiteNum) * days;
        setEuro($('#roomsTotal'), total);
        $('#naechte').html(days);
      }

      [einzelEUR, doppelEUR, suiteEUR, startDateField, endDateField].forEach(function(field) {
        field.keyup(updateRoomsTotal);
      });
      [einzelNum, doppelNum, suiteNum, startDateField, endDateField].forEach(function(field) {
        field.change(updateRoomsTotal);
      });
      updateRoomsTotal();

      var transportEUR = $('#unterkunft\\[transportEUR\\]');
      function updateTransportTotal() {
        setEuro($('#transportTotal'), eurAmount(transportEUR))
      }

      transportEUR.keyup(updateTransportTotal);
      updateTransportTotal();

      $('.hotelstep').click(function () {
        $.ajax('#{veranstaltung.fullyQualifiedUrl() + "/hotelStepClicked"}', {
          data: {
            step: this.name,
            checked: this.checked
          }
        });
      });
    });
  script(src='/clientscripts/check-hotelform.js')
