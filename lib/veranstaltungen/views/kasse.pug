extends ../../../views/layout
include ../../../views/formComponents

block title
  | Veranstaltung

block content
  #edit.modal.fade(tabindex='-1')
    .modal-dialog
      .modal-content
        .modal-header
          h3.modal-title Kasse freigeben<br>
            small Nach dem Freigeben ist keine Änderung mehr möglich!
          button.close(type='button', data-dismiss='modal', aria-hidden='true') &times;
        .modal-body
          .row
            .col-md-12
              .btn-group.pull-right
                button.btn.btn-light(data-dismiss='modal') Abbrechen
                a.btn.btn-success(href=veranstaltung.fullyQualifiedUrl() + '/kassenfreigabe', title='Kassenfreigabe')
                  i.fa.fa-unlock.fa-fw.fa-lg
                  | &nbsp;Kasse freigeben

  -var kasse = veranstaltung.kasse()
  -var kosten = veranstaltung.kosten()
  -var freigegeben = kasse.istFreigegeben()
  .col-12
    form#kasseform(action='/veranstaltungen/submit', method='post')
      +csrf
      +hidden('id', veranstaltung.id())
      +hidden('kopf[confirmed]', veranstaltung.kopf().confirmed() ? 'on' : undefined)
      fieldset
        .row
          .col-md-12
            .page-header
              +submitButtonsFor(veranstaltung, 'kasse', freigegeben)
              h2 Abendkasse für #{veranstaltung.datumForDisplay()}<br>
                small #{veranstaltung.kopf().titel()} #{veranstaltung.kopf().presseIn()}
        if freigegeben
          .row
            .col-md-12
              .btn-group.pull-right
                a.btn.btn-danger.disabled(href=veranstaltung.fullyQualifiedUrl() + '/kassenzettel', title='Kassenzettel anzeigen')
                  i.fa.fa-lock.fa-fw.fa-lg
                  | &nbsp;Kasse ist freigeben
        if accessrights.darfKasseFreigeben() && !freigegeben
          .row
            .col-md-12
              .btn-group.d-flex.justify-content-end
                a.btn.btn-success(data-toggle='modal', data-target='#edit', href='#')
                  i.fa.fa-unlock.fa-fw.fa-lg
                  | &nbsp;Kasse freigeben
        .row
          .col-md-6
            +legendMitBody('reservix', 'Einnahmen Reservix', 'reservixGesamt', 'color-kasse')
              .row
                .col-4
                  +currency('kasse[reservixBruttoEUR]', 'Tickets Brutto (Reservix)', kasse.reservixBruttoEUR(), null, null, freigegeben)
                .col-4
                  +currency('kasse[reservixNettoEUR]', 'Tickets Netto (Reservix)', kasse.reservixNettoEUR(), null, null, freigegeben)
                .col-4
                  +number('kasse[anzahlBesucherReservix]', 'Besucher (Reservix)', kasse.anzahlBesucherReservix(), 'Anzahl der Reservix-Tickets', 0, 999, freigegeben)
  
            +legendMitBody('einnahmen', 'Einnahmen Abendkasse', 'einnahmenGesamt', 'color-kasse')
              .row
                .col-4
                  +currency('kasse[einnahmeTicketsEUR]', 'Tickets (AK)', kasse.einnahmeTicketsEUR(), null, null, freigegeben)
                .col-4
                  +number('kasse[anzahlBesucherAK]', 'Besucher (AK)', kasse.anzahlBesucherAK(), 'Anzahl der bar bezahlten Tickets', 0, 999, freigegeben)
                .col-4
                  +currency('kasse[einnahmeBankEUR]', 'Bareinlage', kasse.einnahmeBankEUR(), 'z.B. Gage', null, freigegeben)
              .row
                .col-8
                  +text('kasse[einnahmeSonstiges1Text]', 'Sonstiges', kasse.einnahmeSonstiges1Text(), null, 'Spende, Mitgliedsbeitrag, etc.', freigegeben)
                .col-4
                  +currency('kasse[einnahmeSonstiges1EUR]', 'Betrag', kasse.einnahmeSonstiges1EUR(), null, null, freigegeben)
              .row
                .col-8
                  +text('kasse[einnahmeSonstiges2Text]', 'Sonstiges', kasse.einnahmeSonstiges2Text(), null, 'Spende, Mitgliedsbeitrag, etc.', freigegeben)
                .col-4
                  +currency('kasse[einnahmeSonstiges2EUR]', 'Betrag', kasse.einnahmeSonstiges2EUR(), null, null, freigegeben)
  
  
          .col-md-6
            +legendMitBody('ausgaben', 'Ausgaben (Bar und mit Beleg)', 'ausgabenGesamt', 'color-kasse')
              .row
                .col-sm-4.col-6
                  if !kosten.gageBAR()
                    +currency('kasse[ausgabeGageEUR]', 'Gage', kasse.ausgabeGageEUR(), null, null, freigegeben)
                  else
                    .form-group
                      label.control-label.text-danger(for='kasse[ausgabeGageEUR]'): i.fa.fa-exclamation-triangle &nbsp; Gage BAR &nbsp;
                        i.fa.fa-exclamation-triangle :
                      input.form-control.currency(id='kasse[ausgabeGageEUR]', type='text', value=kasse.ausgabeGageEUR(), name='kasse[ausgabeGageEUR]', disabled=freigegebe, text-align='right', data-currency-symbol=' €', data-currency-symbol-placement='s', data-decimal-character=',', data-digit-group-separator='')
                .col-sm-4.col-6
                  +currency('kasse[ausgabeCateringEUR]', 'Catering', kasse.ausgabeCateringEUR(), null, null, freigegeben)
                .col-sm-4.col-6
                  +currency('kasse[ausgabeHelferEUR]', 'Personal', kasse.ausgabeHelferEUR(), null, null, freigegeben)
              .row
                .col-8
                  +text('kasse[ausgabeSonstiges1Text]', 'Sonstiges', kasse.ausgabeSonstiges1Text(), null, null, freigegeben)
                .col-4
                  +currency('kasse[ausgabeSonstiges1EUR]', 'Betrag', kasse.ausgabeSonstiges1EUR(), null, null, freigegeben)
              .row
                .col-8
                  +text('kasse[ausgabeSonstiges2Text]', 'Sonstiges', kasse.ausgabeSonstiges2Text(), null, null, freigegeben)
                .col-4
                  +currency('kasse[ausgabeSonstiges2EUR]', 'Betrag', kasse.ausgabeSonstiges2EUR(), null, null, freigegeben)
              .row
                .col-8
                  +text('kasse[ausgabeSonstiges3Text]', 'Sonstiges', kasse.ausgabeSonstiges3Text(), null, null, freigegeben)
                .col-4
                  +currency('kasse[ausgabeSonstiges3EUR]', 'Betrag', kasse.ausgabeSonstiges3EUR(), null, null, freigegeben)
              .row
                .col-sm-9.col-6
                .col-sm-3.col-6
                  +currency('kasse[ausgabeBankEUR]', 'An Bank', kasse.ausgabeBankEUR(), null, null, freigegeben)
        .row
          .col-md-12
            .row
              .col-sm-3.col-6
                +currency('kasse[anfangsbestandEUR]', 'Anfangsbestand', kasse.anfangsbestandEUR(), null, null, freigegeben)
              .col-sm-3.col-6
                .form-group
                  +controlLabel('endbestandEUR', 'Endbestand')
                  b: p#endbestandEUR.form-control-plaintext.currency(data-currency-symbol=' €', data-currency-symbol-placement='s', data-decimal-character=',', data-digit-group-separator='')
  
        .row
          .col-md-12
            hr
            +submitButtonsFor(veranstaltung, 'kasse', freigegeben)

block scripts
  script.
    $(document).ready(function () {
      var einnahmeBankEUR = $('#kasse\\[einnahmeBankEUR\\]');
      var einnahmeTicketsEUR = $('#kasse\\[einnahmeTicketsEUR\\]');
      var einnahmeSonstiges1EUR = $('#kasse\\[einnahmeSonstiges1EUR\\]');
      var einnahmeSonstiges2EUR = $('#kasse\\[einnahmeSonstiges2EUR\\]');

      function updateEinnahmenGesamt() {
        var einnahmenGesamt = eurAmount(einnahmeBankEUR) + eurAmount(einnahmeTicketsEUR)
          + eurAmount(einnahmeSonstiges1EUR) + eurAmount(einnahmeSonstiges2EUR);
        setEuro($('#einnahmenGesamt'), einnahmenGesamt);
        $('#einnahmenGesamt').change(updateEndbestand);
      }

      einnahmeBankEUR.keyup(updateEinnahmenGesamt);
      einnahmeTicketsEUR.keyup(updateEinnahmenGesamt);
      einnahmeSonstiges1EUR.keyup(updateEinnahmenGesamt);
      einnahmeSonstiges2EUR.keyup(updateEinnahmenGesamt);
      updateEinnahmenGesamt();

      var reservixBruttoEUR = $('#kasse\\[reservixBruttoEUR\\]');
      
      function updateReservix() {
        setEuro($('#reservixGesamt'), eurAmount(reservixBruttoEUR));  
      }
      reservixBruttoEUR.keyup(updateReservix);
      updateReservix();

      var ausgabeGageEUR = $('#kasse\\[ausgabeGageEUR\\]');
      var ausgabeCateringEUR = $('#kasse\\[ausgabeCateringEUR\\]');
      var ausgabeHelferEUR = $('#kasse\\[ausgabeHelferEUR\\]');
      var ausgabeSonstiges1EUR = $('#kasse\\[ausgabeSonstiges1EUR\\]');
      var ausgabeSonstiges2EUR = $('#kasse\\[ausgabeSonstiges2EUR\\]');
      var ausgabeSonstiges3EUR = $('#kasse\\[ausgabeSonstiges3EUR\\]');
      var ausgabeBankEUR = $('#kasse\\[ausgabeBankEUR\\]');

      function updateAusgabenGesamt() {
        var ausgabenGesamt = eurAmount(ausgabeGageEUR) +
          eurAmount(ausgabeCateringEUR) + eurAmount(ausgabeHelferEUR) +
          eurAmount(ausgabeSonstiges1EUR) + eurAmount(ausgabeSonstiges2EUR) +
          eurAmount(ausgabeSonstiges3EUR) + eurAmount(ausgabeBankEUR);
        setEuro($('#ausgabenGesamt'), ausgabenGesamt);
        $('#ausgabenGesamt').change(updateEndbestand);
      }

      ausgabeGageEUR.keyup(updateAusgabenGesamt);
      ausgabeCateringEUR.keyup(updateAusgabenGesamt);
      ausgabeHelferEUR.keyup(updateAusgabenGesamt);
      ausgabeSonstiges1EUR.keyup(updateAusgabenGesamt);
      ausgabeSonstiges2EUR.keyup(updateAusgabenGesamt);
      ausgabeSonstiges3EUR.keyup(updateAusgabenGesamt);
      ausgabeBankEUR.keyup(updateAusgabenGesamt);
      updateAusgabenGesamt();

      var anfangsbestandEUR = $('#kasse\\[anfangsbestandEUR\\]');

      function updateEndbestand() {
        var endbestand = eurAmount(anfangsbestandEUR) +
          eurAmount($('#einnahmenGesamt')) - eurAmount($('#ausgabenGesamt'));
        setEuro($('#endbestandEUR'), endbestand);
      }

      anfangsbestandEUR.keyup(updateEndbestand);
      updateEndbestand();
    });
  script(src='/clientscripts/check-kasseform.js')
