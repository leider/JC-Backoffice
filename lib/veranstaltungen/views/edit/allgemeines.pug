extends ../../../../views/layout
include ../../../../views/formComponents
include eintrittspreiseMixins
include kontaktMixins
include bandMixins
include mixins

mixin eventTypSelect(name, label, value, values)
  .form-group
    +controlLabel(name, label)
    select.form-control.selectpicker(id=name, name=name, title = 'Bitte wählen', required)
      each val in values
        option(value = val, selected = value === val, data-content='<span class="' + cssIconClass(val) + '"></span><span class="text-' + cssColorCode(val) + '"> ' + val + '</span>') #{val}


block title
  | Veranstaltung

block content
  -var artist = veranstaltung.artist()
  -var kopf = veranstaltung.kopf()
  -var vertrag = veranstaltung.vertrag()
  -var kosten = veranstaltung.kosten()
  -var eintrittspreise = veranstaltung.eintrittspreise()

  .col-12
    form#veranstaltungform.needs-validation(action='/veranstaltungen/submit', method='post', novalidate)
      +editHeader(veranstaltung, 'allgemeines')
        .col-md-6
          +legendMitBody('event', 'Event')
            .row.mb-3
              .col-12.col-md-3
                if accessrights.isBookingTeam()
                  +checkbox('kopf[confirmed]', 'Ist bestätigt', kopf.confirmed())
                else
                  +hidden('kopf[confirmed]', kopf.confirmed() ? 'on' : undefined)
              .col-12.col-md-3
                +checkbox('artist[brauchtHotel]', 'Braucht Hotel', artist.brauchtHotel())

            .row
              .col-sm-6
                +textRequired('kopf[titel]', 'Titel', kopf.titel(), 'Titel für die Veranstaltung')
              .col-6.col-sm-3
                +eventTypSelect('kopf[eventTyp]', 'Typ', kopf.eventTyp(), optionen.typen())
              .col-6.col-sm-3
                +text('reservixID', 'Reservix ID', veranstaltung.reservixID(), 'Die EventID von Reservix')

            .row
              .col-6
                .row
                  .col-6.pl-2.pr-1
                    +date('startDate', 'Start', veranstaltung.startMoment().format('L'), 'Startzeitpunkt', veranstaltung.minimalStartForEdit().format('L'))
                  .col-6.pl-1.pr-2
                    +time('startTime', veranstaltung.startMoment().format('LT'))
              .col-6
                .row
                  .col-6.pl-2.pr-1
                    +date('endDate', 'Ende', veranstaltung.endMoment().format('L'), 'Erwartetes Ende', veranstaltung.minimalStartForEdit().format('L'))
                  #dates.col-6.pl-1.pr-2
                    +time('endTime', veranstaltung.endMoment().format('LT'))

            .row
              .col-4
                +singleselectRequired('kopf[ort]', 'Ort', kopf.ort(), orte.alleNamen())
                +hidden('kopf[pressename]', kopf.pressename())
                +hidden('kopf[presseIn]', kopf.presseIn())
              .col-4
                +number('kopf[flaeche]', 'Fläche', kopf.flaeche(), null, 0, 1000)
              .col-4
                +currency('kosten[saalmiete]', 'Saalmiete', kosten.saalmiete())

            .row
              .col-4
                .form-group
                  label(for='kopf[kooperation]')
                    span.tooltiplabel(data-original-title='Anhaken, wenn die Rechnung an den Kooperationspartner gehen soll') Koop (Rechnung):&nbsp;
                      i.fas.fa-question-circle
                  .input-group
                    select.form-control.selectpicker(id='kopf[kooperation]', name='kopf[kooperation]')
                      each val in optionen.kooperationen()
                        option(value = val, selected = kopf.kooperation() === val) #{val}
                    .input-group-append
                      .input-group-text.pl-1.pr-0
                        .form-check.abc-checkbox.abc-checkbox-success
                          -var checkID = 'kopf[rechnungAnKooperation]'
                          input.form-check-input(type='checkbox', id=checkID, name=checkID, checked=(kopf.rechnungAnKooperation() ? 'true' : undefined))
                          label.form-check-label(for=checkID) #{''}

              .col-4
                +singleselectPreis('eintrittspreise[preisprofil]', 'Preisprofil', eintrittspreise.preisprofil(), optionen.preisprofile())
              .col-4
                +singleselect('kopf[genre]', 'Genre', kopf.genre(), optionen.genres())

          +legendMitBody('artist', 'Künstler')
            .row
              .col-6
                +text('artist[bandname]', 'Bandname', artist.bandname(), 'wird für den Vertrag benötigt')
              .col-3
                +number('artist[numMusiker]', 'Musiker', artist.numMusiker(), null, '1', '30')
              .col-3
                +number('artist[numCrew]', 'Crew', artist.numCrew(), null, '0', '30')
            .row
              .col-sm-6
                +editableMultiselect('artist[name]', 'Namen', artist.name(), optionen.artists())
              .col-6.col-sm-3
                +currency('kosten[gagenEUR]', 'Gage (Netto)', kosten.gagenEUR())
              .col-6.col-sm-3
                +singleselect('kosten[deal]', 'Deal', kosten.deal(), ['ohne', '100%', '90%', '80%', '70%', '60%'])
            .row
              .col-6.col-sm-4
                +checkbox('artist[isBawue]', 'BaWü-Förderung', artist.isBawue())
              .col-6.col-sm-4
                +checkbox('artist[isAusland]', 'aus dem Ausland', artist.isAusland())

          +legendMitBody('kommentar', 'Kommentar')
            .row
              .col-sm-12
                +hightextarea('kopf[beschreibung]', 'Notizen / Gäste / Reservierung, etc.', kopf.beschreibung())

        .col-md-6
          +kontakt(veranstaltung, optionen.agenturen(), 'Agentur / Verantwortlicher', 'agentur')
          +legendMitBody('vertrag', 'Vertrag')
            .row
              .col-md-6
                +singleselect('vertrag[art]', 'Art', vertrag.art(), Vertrag.arten())
              .col-md-6
                +singleselect('vertrag[sprache]', 'Sprache', vertrag.sprache(), ['Deutsch', 'Englisch', 'Regional'])
            if user && (accessrights.isBookingTeam())
              .row
                .col-12
                  a.btn.btn-primary.float-right(href=veranstaltung.fullyQualifiedUrlForVertrag() + '/' + vertrag.sprache(), title='Vertrag generieren')
                    | Vertrag generieren
            .row
              .col-12
                +uploader('vertragupload', 'Datei', null, vertrag.datei(), {id: veranstaltung.id(), typ: 'vertrag'})

block head
  link(rel='stylesheet', href='/stylesheets/bootstrap-datepicker3.css')
  link(rel='stylesheet', href='/stylesheets/fileinput.css')

block scripts
  script(src='/clientscripts/fileinput.min.js')
  script(src='/clientscripts/bootstrap-datepicker.min.js')
  script(src='/clientscripts/bootstrap-datepicker.de.min.js')
  script(src='/clientscripts/simple-timepicker.min.js')
  script(src='/clientscripts/bootstrap-markdown.min.js')
  +kontaktScript('agentur')
  script.
    $(document).ready(function () {
      var startDate = $('#veranstaltungform [name=startDate]');
      var startTime = $('#veranstaltungform [name=startTime]');
      var endDate = $('#veranstaltungform [name=endDate]');
      var endTime = $('#veranstaltungform [name=endTime]');
      var ort = $('#kopf\\[ort\\]');

      dateAdapter(startDate, startTime, endDate, endTime);

      var alleOrte = JSON.parse('!{JSON.stringify(orte.orte())}');

      function ortchanged(auswahl) {
        var derOrt = alleOrte.find(function (o) {
          return o.name === ort.val();
        });
        $('#kopf\\[flaeche\\]').val(derOrt.flaeche);
        $('input[name="kopf\\[presseIn\\]"]').val(derOrt.presseIn);
        $('input[name="kopf\\[pressename\\]"]').val(derOrt.pressename);
      }

      $('#kopf\\[ort\\]').change(ortchanged);

      function validateDateAndTime() {
        var startDateVal = $('#veranstaltungform [name=startDate]').val();
        var startTimeVal = $('#veranstaltungform [name=startTime]').val();
        var endDateVal = $('#veranstaltungform [name=endDate]').val();
        var endTimeVal = $('#veranstaltungform [name=endTime]').val();

        var start = toUtc(startDateVal, startTimeVal);
        var end = toUtc(endDateVal, endTimeVal);
        var isValid = endDate !== '' && endTime !== '' && end && start && end.getTime() - start.getTime() > 0;
        if (isValid) {
          startDate.removeClass('is-invalid');
          startTime.removeClass('is-invalid');
          endDate.removeClass('is-invalid');
          endTime.removeClass('is-invalid');
        } else {
          startDate.addClass('is-invalid');
          startTime.addClass('is-invalid');
          endDate.addClass('is-invalid');
          endTime.addClass('is-invalid');
        }
      }

      endDate.change(validateDateAndTime);
      endTime.change(validateDateAndTime);
    });
