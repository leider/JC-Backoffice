extends ../../../views/layout
include ../../../views/formComponents

mixin button(veranstaltung, name, nameInMethod)
  -var staff = veranstaltung.staff()
  if !staff[name]().includes(user.id) && !staff[name]().includes(user.id.toLowerCase())
    a.btn.btn-success.btn-sm(href='/teamseite/add' + nameInMethod + '/' + veranstaltung.id()) Ich übernehme
  else
    a.btn.btn-danger.btn-sm(href='/teamseite/remove' + nameInMethod + '/' + veranstaltung.id()) Ich kann nicht

mixin people(veranstaltung, name)
  -var staff = veranstaltung.staff()
  span.text-capitalize #{staff[name]().join(', ')}

mixin panelView(veranstaltungen)
  -var count = 0
  -var nearFuture = moment(); nearFuture.add(2, 'months')
  .row
    for veranstaltung in veranstaltungen
      -var kopf = veranstaltung.kopf()
      -var staff = veranstaltung.staff()
      -var editlink = (user && accessrights.isOrgaTeam()) ? veranstaltung.fullyQualifiedUrl() + '/ausgaben' : null 
      .col-xl-3.col-lg-4.col-sm-6
        +panelMitBody('panel' + ++count, veranstaltung.datumForDisplayShort() + ' ' + kopf.presseIn() + ' :<br>' + kopf.titel(), null, kopf.cssColorCode(), null, editlink, veranstaltung.startMoment().isAfter(nearFuture))
          table.table.table-striped.table-sm
            if (!staff['kasseVNotNeeded']() || !staff['kasseNotNeeded']())
              tr: td(colspan=3): h5.mb-0 Kasse
              if !staff['kasseVNotNeeded']()
                tr 
                  th Eins: #{' '}
                  td: +people(veranstaltung, 'kasseV')
                  td: +button(veranstaltung, 'kasseV', 'KasseV')
              if !staff['kasseNotNeeded']()
                tr
                  th Zwei: #{' '}
                  td: +people(veranstaltung, 'kasse')
                  td: +button(veranstaltung, 'kasse', 'Kasse')
            if (!staff['technikerVNotNeeded']() || !staff['technikerNotNeeded']())
              tr: td(colspan=3): h5.mb-0 Technik
              if !staff['technikerVNotNeeded']()
                tr
                  th Eins: #{' '}
                  td: +people(veranstaltung, 'technikerV')
                  td: +button(veranstaltung, 'technikerV', 'TechnikerV')
              if !staff['technikerNotNeeded']()
                tr
                  th Zwei: #{' '}
                  td: +people(veranstaltung, 'techniker')
                  td: +button(veranstaltung, 'techniker', 'Techniker')
            if !staff['modNotNeeded']()
              tr: td(colspan=3): h5.mb-0 Master
              tr
                th &nbsp;
                td: +people(veranstaltung, 'mod')
                td: +button(veranstaltung, 'mod', 'MoD')
        
mixin userpanel(user, count)
  -var editlink = accessrights.canEditUser(user.id) ? '/users/' + user.id : null
  .col-xl-3.col-lg-4.col-sm-6
    +panelMitBody('user' + count, user.name, null, null, null, editlink, accessrights.memberId() !== user.id)
      table.table.table-striped.table-sm
        tr
          th: .form-control-plaintext E-Mail:
          td: .mailtoify.form-control-plaintext #{user.email}
        if accessrights.canEditUser(user.id)
          tr
            th: .form-control-plaintext T-Shirt:
            td
              select.form-control.form-control-sm.enhance(id=user.id, name='tshirt', style='width:100%')
                -var value = user.tshirt
                each val in shirtsizes
                  option(value = val, selected = value === val) #{val}
          tr
            th: .form-control-plaintext Telefon:
            td: input.form-control.form-control-sm.trim-text(id=user.id, type='text', name='tel', value=user.tel, style='width:100%')
        else
          tr
            th: .form-control-plaintext T-Shirt:
            td: .form-control-plaintext #{user.tshirt}
          tr
            th: .form-control-plaintext Telefon:
            td: .telify.form-control-plaintext #{user.tel}

block title
  | Teamseite

block content
  .col-12
    .row
      .col-12
        .page-header
          .btn-group.float-right
            a.btn.btn-light(href=webcalURL, title='als iCal'): i.far.fa-calendar-alt.fa-fw
          h2 Team
        p <b>Kasse 1</b> und <b>Techniker 1</b> sind am Abend jeweils die <b>Verantwortlichen</b>. Bitte denke daran, rechtzeitig vor der Veranstaltung da zu sein!
        p Mit dem Knopf rechts kannst Du den Kalender abonnieren,
        +panelView(veranstaltungen)
    .row
      .col-12
        hr
        h2 Übersicht der Benutzer
        -var shirtsizes = ['', 'S', 'M', 'L', 'XL', 'XXL', 'XXXL', 'No Shirt', 'Ladies\' XS', 'Ladies\' S', 'Ladies\' M', 'Ladies\' L', 'Ladies\' XL', 'Ladies\' XXL' ]
    .row
      +userpanel(accessrights.member(), ++count)
      -var count = 0;
      for user in users
        if accessrights.memberId() !== user.id
          +userpanel(user, ++count)
              
block scripts
  script.
    $(document).ready(function () {
      $('a.chevron').click(function () {
        $(this).find('i').toggleClass('fa-caret-square-down fa-caret-square-right');
      });

      function shirtsizeChanged() {
        $.ajax('/users/tshirt-size-for', {data: {user: this.id, value: this.value}})
      } 
      $('select[name="tshirt"]').change(shirtsizeChanged);
      
      function telChanged() {
        $.ajax('/users/tel-for', {data: {user: this.id, value: this.value}})
      } 
      $('input[name="tel"]').change(telChanged);
    });
  
