extends ../../../views/layout
include ../../../views/formComponents
include mixins
include ../../users/views/userMixins

mixin button(veranstaltung, name, nameInMethod)
  - var staff = veranstaltung.staff();
  if !staff[name]().includes(user.id) && !staff[name]().includes(user.id.toLowerCase())
    a.btn.btn-success.btn-sm(href=`/teamseite/add${nameInMethod}/${encodeURIComponent(veranstaltung.id())}`, title="Ich kann"): i.fa-fw.fa-lg.fas.fa-plus-circle
  else
    a.btn.btn-danger.btn-sm(href=`/teamseite/remove${nameInMethod}/${encodeURIComponent(veranstaltung.id())}`, title="Ich kann nicht"): i.fa-fw.fa-lg.fas.fa-minus-circle

mixin people(veranstaltung, name)
  - var staff = veranstaltung.staff();
  .mt-1: span.text-capitalize #{staff[name]().join(', ')}

mixin monatHeadline(veranstaltung)
  h4.pt-1.pb-2.px-1.bg-primary.text-white #{veranstaltung.startDatumUhrzeit().monatLangJahrKompakt}
    .btn-group.btn-group-sm.float-right
      a.btn.btn-secondary.btn-sm(href=`/veranstaltungen/texte/${veranstaltung.startDatumUhrzeit().fuerUnterseiten}`)
        i.far.fa-file-alt.fa-fw
        | #{' '} Presseexte
      a.btn.btn-secondary.btn-sm(href=`/veranstaltungen/monat/${veranstaltung.startDatumUhrzeit().fuerUnterseiten}`)
        i.fas.fa-align-justify.fa-fw
        | #{' '} Übersicht

mixin panelView(groupedVeranstaltungen)
  - var count = 0;
  - var nearFuture = new DatumUhrzeit().plus({ monate: 1 });
  each month in Object.keys(groupedVeranstaltungen)
    - var veranstOfMonth = groupedVeranstaltungen[month];
    .row
      .col-12
        +monatHeadline(veranstOfMonth[0])
      each veranstaltung in veranstOfMonth
        - var collapsed = veranstaltung.startDatumUhrzeit().istNach(nearFuture);
        - var kopf = veranstaltung.kopf();
        - var id = `panel${++count}`;
        - var staff = veranstaltung.staff();
        .col-xl-4.col-md-6
          .card.mb-2(class=`border-${cssColorCode(kopf.eventTyp())}`)
            .card-header.p-0(class=`color-${cssColorCode(kopf.eventTyp())}`)
              +standardCardTitle(veranstaltung, id, collapsed)
              if veranstaltung.kasseFehlt()
                h5.alert-danger.p-1.mb-0
                  i.fas.fa-exclamation-circle
                  | #{' '} Kasse gesucht!
              if staff.noStaffNeeded() && staff.modNotNeeded()
                h5.alert-success.p-1.mb-0
                  i.fas.fa-check-circle
                  | #{' '} Kooperation

            if !staff.noStaffNeeded() || !staff.modNotNeeded()
              .collapse.cardcontent(id=id, class=collapsed ? '' : ' show')
                table.table.table-striped.table-sm
                  if (!staff['kasseVNotNeeded']() || !staff['kasseNotNeeded']())
                    tr: td(colspan=3): h5.mb-0 Kasse
                    if !staff['kasseVNotNeeded']()
                      tr
                        th: .mt-1 Eins:
                        td: +people(veranstaltung, 'kasseV')
                        td.text-right: +button(veranstaltung, 'kasseV', 'KasseV')
                    if !staff['kasseNotNeeded']()
                      tr
                        th: .mt-1 Zwei:
                        td: +people(veranstaltung, 'kasse')
                        td.text-right: +button(veranstaltung, 'kasse', 'Kasse')
                  if (!staff['technikerVNotNeeded']() || !staff['technikerNotNeeded']())
                    tr: td(colspan=3): h5.mb-0 Technik
                    if !staff['technikerVNotNeeded']()
                      tr
                        th: .mt-1 Eins:
                        td: +people(veranstaltung, 'technikerV')
                        td.text-right: +button(veranstaltung, 'technikerV', 'TechnikerV')
                    if !staff['technikerNotNeeded']()
                      tr
                        th: .mt-1 Zwei:
                        td: +people(veranstaltung, 'techniker')
                        td.text-right: +button(veranstaltung, 'techniker', 'Techniker')
                  if !staff['modNotNeeded']()
                    tr: td(colspan=3): h5.mb-0 Master
                    tr
                      th &nbsp;
                      td: +people(veranstaltung, 'mod')
                      td.text-right: +button(veranstaltung, 'mod', 'MoD')
                  if !staff['merchandiseNotNeeded']()
                    tr: td(colspan=3): h5.mb-0 Merchandise
                    tr
                      th &nbsp;
                      td: +people(veranstaltung, 'merchandise')
                      td.text-right: +button(veranstaltung, 'merchandise', 'Merchandise')

block title
  | Teamseite

block content
  .col-12
    .row
      .col-lg-8
        .page-header
          .btn-group.float-right
            if accessrights.isOrgaTeam()
              a.btn.btn-light(href="/veranstaltungen/zukuenftige", title="administration")
                i.fas.fa-edit.fa-fw
                | &nbsp;Admin
          h2 Team
          p <b>Kasse 1</b> und <b>Techniker 1</b> sind am Abend jeweils die <b>Verantwortlichen</b>. Bitte denke daran, rechtzeitig vor der Veranstaltung da zu sein!
          p
            a.btn.btn-light(href=webcalURL, title="als iCal"): i.far.fa-calendar-alt
            | #{' '} Hiermit kannst Du den Kalender abonnieren.
        +zuAufButtons
        +panelView(groupedVeranstaltungen)
      .col-lg-4
        +calendar(icals)
    .row
      .col-12
        hr
        .page-header
          h2 Übersicht der Benutzer
    .row
      +userpanel(accessrights.member(), ++count)
      - var count = 0;
      each user in users
        if accessrights.memberId() !== user.id
          +userpanel(user, ++count)

block scripts
  script.
    $(document).ready(function () {
      function shirtsizeChanged() {
        $.ajax('/users/tshirt-size-for', {data: {user: this.id, value: this.value}})
      }

      $('select[name="tshirt"]').change(shirtsizeChanged);

      function telChanged() {
        $.ajax('/users/tel-for', {data: {user: this.id, value: this.value}})
      }

      $('input[name="tel"]').change(telChanged);
    });
