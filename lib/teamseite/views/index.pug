extends ../../../views/layout
include ../../../views/formComponents
include mixins
include ../../users/views/userMixins
include ../../veranstaltungen/views/veranstaltungMixins
  
mixin button(veranstaltung, name, nameInMethod)
  -var staff = veranstaltung.staff()
  if !staff[name]().includes(user.id) && !staff[name]().includes(user.id.toLowerCase())
    a.btn.btn-success.btn-sm(href='/teamseite/add' + nameInMethod + '/' + veranstaltung.id(), title='Ich kann'): i.fa-fw.fa-lg.fas.fa-plus-circle
  else
    a.btn.btn-danger.btn-sm(href='/teamseite/remove' + nameInMethod + '/' + veranstaltung.id(), title='Ich kann nicht'): i.fa-fw.fa-lg.fas.fa-minus-circle

mixin people(veranstaltung, name)
  -var staff = veranstaltung.staff()
  .mt-1: span.text-capitalize #{staff[name]().join(', ')}

mixin panelView(veranstaltungen)
  -var count = 0
  -var nearFuture = moment(); nearFuture.add(1, 'months')
  -var monatAlt = -1;
  | <div class='row'>
  for veranstaltung in veranstaltungen
    if monatAlt === -1 || monatAlt !== veranstaltung.startMoment().month()
      | </div><div class='row'>
      .col-12
        +monatHeadline(veranstaltung)

    -monatAlt = veranstaltung.startMoment().month();
    -var kopf = veranstaltung.kopf()
    -var staff = veranstaltung.staff()
    -var infotext = staff.noStaffNeeded() && staff.modNotNeeded() ? '<div class="alert-success text-center"><i class="fas fa-check-circle"></i> Niemand benötigt</div>' : (veranstaltung.kasseFehlt() ? '<div class="alert-danger text-center"><i class="fas fa-exclamation-circle"></i> Kasse gesucht!</div>' : '')
    .col-xl-4.col-md-6
      -var id = 'panel' + ++count
      -var collapsed = veranstaltung.startMoment().isAfter(nearFuture)
      .card.mb-2(class = 'border-' + (kopf.cssColorCode() || 'general'))
        .card-header.p-0(class = 'color-' + (kopf.cssColorCode() || 'general'))
          table(width='100%'): tr.align-top
            td.text-left: .btn-group-vertical
              a.inherit-color.chevron.panel(data-toggle='collapse', data-target='#' + id)
                if collapsed
                  i.far.fa-caret-square-right.fa-fw.fa-lg
                else
                  i.far.fa-caret-square-down.fa-fw.fa-lg
            td: a.chevron(data-toggle='collapse', data-target='#' + id)
              h6 #{veranstaltung.datumForDisplayShort() + ' ' + kopf.presseIn()}:<br> 
                h5 #{kopf.titel()}
            td.text-right: .btn-group-vertical
              a.py-0.px-1.text-white.bg-secondary(href=veranstaltung.fullyQualifiedUrl() + '/preview')
                i.fas.fa-eye.fa-lg
          if veranstaltung.kasseFehlt()
            h4.alert-danger.p-1.mb-0: i.fas.fa-exclamation-circle #{' '} Kasse gesucht!
          if staff.noStaffNeeded() && staff.modNotNeeded()
            h4.alert-success.p-1.mb-0: i.fas.fa-check-circle #{' '} Kooperation


        if !staff.noStaffNeeded() || !staff.modNotNeeded()
          div(id = id, class = 'collapse' + (collapsed ? '' : ' show') + ' cardcontent')
            table.table.table-striped.table-sm
              if (!staff['kasseVNotNeeded']() || !staff['kasseNotNeeded']())
                tr: td(colspan=3): h5.mb-0 Kasse
                if !staff['kasseVNotNeeded']()
                  tr 
                    th: .mt-1 Eins:
                    td: +people(veranstaltung, 'kasseV')
                    td.text-right: +button(veranstaltung, 'kasseV', 'KasseV')
                if !staff['kasseNotNeeded']()
                  tr
                    th: .mt-1 Zwei:
                    td: +people(veranstaltung, 'kasse')
                    td.text-right: +button(veranstaltung, 'kasse', 'Kasse')
              if (!staff['technikerVNotNeeded']() || !staff['technikerNotNeeded']())
                tr: td(colspan=3): h5.mb-0 Technik
                if !staff['technikerVNotNeeded']()
                  tr
                    th: .mt-1 Eins:
                    td: +people(veranstaltung, 'technikerV')
                    td.text-right: +button(veranstaltung, 'technikerV', 'TechnikerV')
                if !staff['technikerNotNeeded']()
                  tr
                    th: .mt-1 Zwei:
                    td: +people(veranstaltung, 'techniker')
                    td.text-right: +button(veranstaltung, 'techniker', 'Techniker')
              if !staff['modNotNeeded']()
                tr: td(colspan=3): h5.mb-0 Master
                tr
                  th &nbsp;
                  td: +people(veranstaltung, 'mod')
                  td.text-right: +button(veranstaltung, 'mod', 'MoD')
  | </div>   
  
  
block title
  | Teamseite

block content
  .col-12
    .row
      .col-lg-8
        .page-header
          .btn-group.float-right
            if accessrights.isOrgaTeam()
              a.btn.btn-light(href='/veranstaltungen/zukuenftige', title='administration')
                i.fas.fa-edit.fa-fw
                | &nbsp;Admin
          h2 Team
          p <b>Kasse 1</b> und <b>Techniker 1</b> sind am Abend jeweils die <b>Verantwortlichen</b>. Bitte denke daran, rechtzeitig vor der Veranstaltung da zu sein!
          p 
            a.btn.btn-light(href=webcalURL, title='als iCal'): i.far.fa-calendar-alt
            | #{' '} Hiermit kannst Du den Kalender abonnieren.
        +zuAufButtons
        +panelView(veranstaltungen)
      .col-lg-4
        +calendar(icals)
    .row
      .col-12
        hr
        .page-header
          h2 Übersicht der Benutzer
    .row
      +userpanel(accessrights.member(), ++count)
      -var count = 0;
      for user in users
        if accessrights.memberId() !== user.id
          +userpanel(user, ++count)
              
block head
  link(rel='stylesheet', href='/stylesheets/fullcalendar.css')

block scripts
  script.
    $(document).ready(function () {
      function shirtsizeChanged() {
        $.ajax('/users/tshirt-size-for', {data: {user: this.id, value: this.value}})
      } 
      $('select[name="tshirt"]').change(shirtsizeChanged);
      
      function telChanged() {
        $.ajax('/users/tel-for', {data: {user: this.id, value: this.value}})
      } 
      $('input[name="tel"]').change(telChanged);
    });
  
