extends ../../../views/layout
include ../../../views/formComponents
include mixins

mixin checkedButton(veranstaltung, section, name)
  if section.checked
    .text-capitalize.alert-success: a.inherit-color(href=`${veranstaltung.fullyQualifiedUrl()}/${name}`)
      i.fas.fa-check.fa-fw
      | #{` ${name}`}
  else
    .text-capitalize.alert-danger: a.inherit-color(href=`${veranstaltung.fullyQualifiedUrl()}/${name}`)
      i.fas.fa-exclamation-circle.fa-fw
      | #{` ${name}`}

mixin multiselectSmall(id, name, value, tags)
  select.form-control.selectpicker(multiple, id=id, name=name, data-selected-text-format="count > 2")
    each tag in tags
      option(selected=value.indexOf(tag) > -1) #{tag}

mixin peopleAndButton(veranstaltung, name, allUsers)
  - var checkID = `staff[${name}NotNeeded]`;
  .input-group
    +multiselectSmall(`staff[${name}]${veranstaltung.id()}`, `staff[${name}]`, veranstaltung.staff()[name](), allUsers.map(user => user.id))
    .input-group-append
      .input-group-text.pl-1.pr-0
        .form-check.abc-checkbox.abc-checkbox-success
          input.form-check-input(
            type="checkbox",
            id=checkID + veranstaltung.id(),
            name=checkID,
            checked=!veranstaltung.staff()[`${name}NotNeeded`]() ? 'true' : undefined
          )
          label.form-check-label(for=checkID + veranstaltung.id()) #{''}

mixin submitButtonsFor(veranstaltung)
  .btn-group.btn-group-sm.float-right.m-1
    +submitButton(veranstaltung, null, 'allgemeines', 'Allgemeines', 'fa-keyboard')
    +submitButton(veranstaltung, null, 'technik', 'Technik', 'fa-microphone-alt')
    +submitButton(veranstaltung, null, 'ausgaben', 'Ausgaben', 'fa-euro-sign')
    if veranstaltung.artist().brauchtHotel()
      +submitButton(veranstaltung, null, 'hotel', 'Hotel', 'fa-bed')
    +submitButton(veranstaltung, null, 'kasse', 'Kasse', 'fa-money-bill-alt')
    +submitButton(veranstaltung, null, 'presse', 'Presse', 'fa-newspaper')
    if !veranstaltung.kopf.confirmed
      span.btn.btn-light.modaldialog(
        data-toggle="modal",
        data-target="#loeschdialog",
        data-link='/veranstaltungen/deleteVeranstaltungDialog/' + encodeURIComponent(veranstaltung.url())
      )
        i.fas.fa-fw.fa-trash-alt.text-danger
    +submitButton(veranstaltung, null, 'copy', 'Kopieren', 'fa-copy')
    button.btn.btn-sm.btn-success(type="submit"): i.fas.fa-fw.fa-save(title="Speichern")

mixin monatHeadline(veranstaltung)
  h4.pt-1.pb-2.px-1.bg-primary.text-white #{veranstaltung.startDatumUhrzeit().monatLangJahrKompakt}
    .btn-group.btn-group-sm.float-right
      if !veranstaltung.startDatumUhrzeit().istGeraderMonat
        a.btn.btn-secondary.btn-sm(href='/programmheft/' + veranstaltung.startDatumUhrzeit().fuerKalenderViews)
          i.far.fa-newspaper.fa-fw
          | #{' '} Programmheft
      a.btn.btn-secondary.btn-sm(href='/veranstaltungen/texte/' + veranstaltung.startDatumUhrzeit().fuerUnterseiten)
        i.far.fa-file-alt.fa-fw
        | #{' '} Presseexte
      a.btn.btn-secondary.btn-sm(href='/veranstaltungen/monat/' + veranstaltung.startDatumUhrzeit().fuerUnterseiten)
        i.fas.fa-align-justify.fa-fw
        | #{' '} Übersicht

mixin panelView(groupedVeranstaltungen)
  - var count = 0;
  - var nearFuture = new DatumUhrzeit().plus({ monate: 1 });
  - var nearPast = new DatumUhrzeit().minus({ monate: 1 });
  each month in Object.keys(groupedVeranstaltungen)
    - var veranstOfMonth = groupedVeranstaltungen[month];
    .row
      .col-12
        +monatHeadline(veranstOfMonth[0])
      each veranstaltung in veranstOfMonth
        - var collapsed = veranstaltung.startDatumUhrzeit().istNach(nearFuture) || veranstaltung.startDatumUhrzeit().istVor(nearPast);
        - var kopf = veranstaltung.kopf;
        - var id = 'panel' + ++count;
        form#veranstaltungform.col-xl-4.col-md-6(action="/veranstaltungen/updateStaff", method="post")
          +hidden('id', veranstaltung.id())
          +csrf
          .card.mb-2(class=`border-${cssColorCode(kopf.eventTyp)}`)
            .card-header.p-0(class=`color-${cssColorCode(kopf.eventTyp)}`)
              table(width="100%")
                if !veranstaltung.kopf.confirmed
                  tr: td.p-0(colspan=2)
                    h5.m-0.alert-danger.text-center
                      i.fas.fa-exclamation-circle.fa-fw
                      | #{' '} UNBESTÄTIGT #{' '}
                      i.fas.fa-exclamation-circle.fa-fw
              +standardCardTitle(veranstaltung, id, collapsed)
              table(width="100%")
                tr
                  td.p-0(width="33%"): +checkedButton(veranstaltung, veranstaltung.presse, 'presse')
                  td.p-0(width="33%"): +checkedButton(veranstaltung, veranstaltung.technik, 'technik')
                  if veranstaltung.artist().brauchtHotel()
                    td.p-0(width="33%"): +checkedButton(veranstaltung, veranstaltung.unterkunft(), 'hotel')

            .collapse.cardcontent(id=id, class=collapsed ? '' : ' show')
              +submitButtonsFor(veranstaltung)
              table.table.table-striped.table-sm
                tr: td(colspan=2): h5.mb-0 Kasse
                tr
                  th(width="20em"): .form-control-plaintext Eins:
                  td: +peopleAndButton(veranstaltung, 'kasseV', users)
                tr
                  th: .form-control-plaintext Zwei:
                  td: +peopleAndButton(veranstaltung, 'kasse', users)
                tr: td(colspan=3): h5.mb-0 Technik
                tr
                  th: .form-control-plaintext Eins:
                  td: +peopleAndButton(veranstaltung, 'technikerV', users)
                tr
                  th: .form-control-plaintext Zwei:
                  td: +peopleAndButton(veranstaltung, 'techniker', users)
                tr: td(colspan=3): h5.mb-0 Master
                tr
                  th: .form-control-plaintext &nbsp;
                  td: +peopleAndButton(veranstaltung, 'mod', users)
                tr: td(colspan=3): h5.mb-0 Merchandise
                tr
                  th: .form-control-plaintext &nbsp;
                  td: +peopleAndButton(veranstaltung, 'merchandise', users)

block title
  | Veranstaltungen

block content
  .col-12
    .row
      .col-lg-8
        .page-header
          .btn-group.float-right
            a.btn.btn-light(href="/veranstaltungen/new", title="Neu"): i.far.fa-file.fa-fw
            a.btn.btn-light(href=webcalURL, title="als iCal"): i.far.fa-calendar-alt
            .dropdown
              button.btn.btn-light.dropdown-toggle(type="button", data-toggle="dropdown")
                | #{titel} &nbsp;
                span.caret
              .dropdown-menu
                a.dropdown-item(href="/veranstaltungen/zukuenftige") Zukünftige
                a.dropdown-item(href="/veranstaltungen/vergangene") Vergangene

          h2 Veranstaltungen
        +zuAufButtons
        +panelView(groupedVeranstaltungen)
      .col-lg-4
        +calendar(icals)
