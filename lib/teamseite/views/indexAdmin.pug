extends ../../../views/layout
include ../../../views/formComponents
include mixins
include ../../veranstaltungen/views/veranstaltungMixins
  
mixin multiselectSmall(id, name, value, tags)
  select.form-control.selectpicker(multiple, id=name, name=name, data-selected-text-format='count > 2')
    each tag in tags
      option(selected = value.indexOf(tag) > -1) #{tag}

mixin people(veranstaltung, name, allUsers)
  -var id = 'staff[' + name + 'NotNeeded]'
  +multiselectSmall('staff[' + name + ']' + veranstaltung.id(), 'staff[' + name + ']', veranstaltung.staff()[name](), allUsers.map(user => user.id))
      
mixin button(veranstaltung, name, allUsers)
  -var id = 'staff[' + name + 'NotNeeded]'
  .form-control-plaintext
    +checkbox(id, 'Benötigt', !veranstaltung.staff()[name + 'NotNeeded'](), veranstaltung.id())
      
mixin panelView(veranstaltungen)
  -var count = 0
  -var nearFuture = moment(); nearFuture.add(1, 'months')
  -var nearPast = moment(); nearPast.subtract(1, 'months')
  -var monatAlt = -1;
  | <div class='row'>
  for veranstaltung in veranstaltungen
    if monatAlt === -1 || monatAlt !== veranstaltung.startMoment().month()
      | </div><div class='row'>
      .col-12
        +monatHeadline(veranstaltung)

    -monatAlt = veranstaltung.startMoment().month();
    -var shouldCollapse = veranstaltung.startMoment().isAfter(nearFuture) || veranstaltung.startMoment().isBefore(nearPast)
    -var kopf = veranstaltung.kopf()
    -var editlink = veranstaltung.fullyQualifiedUrl() + '/preview'
      form#veranstaltungform.col-xl-4.col-md-6(action='/veranstaltungen/updateStaff', method='post')
        +hidden('id', veranstaltung.id())
        +csrf
        -var reservixSymbol = veranstaltung.reservixID() ? '<span class="badge float-right" style="background-color: #F8500D !important"><img src="/img/rex_21x21.png" width="14">&nbsp;' + veranstaltung.kasse().anzahlBesucherReservix() + '</span>' : ''
        -var ueberschrift = (!veranstaltung.kopf().confirmed() ? '<span class="text-danger">[GEPLANT] ': '') + veranstaltung.datumForDisplayShort() + ' ' + kopf.presseIn() + ' :' + reservixSymbol + '<br>' + kopf.titel() + (!veranstaltung.kopf().confirmed() ? '</span>' : '')
        +panelMitBody('panel' + ++count, ueberschrift, null, kopf.cssColorCode(), null, editlink, shouldCollapse)
          table.table.table-striped.table-sm
            tr: td(colspan=3)
              +submitButtonsFor(veranstaltung, null, true)
            tr: td(colspan=3)
              +checkedButton(veranstaltung, veranstaltung.presse(), 'presse', 'presse')
              +checkedButton(veranstaltung, veranstaltung.kosten(), 'ausgaben', 'costs')

            tr: td(colspan=3): h5.mb-0 Kasse
            tr
              th(width='20em'): .form-control-plaintext Eins:
              td: +people(veranstaltung, 'kasseV', users)
              td(width='120em'): +button(veranstaltung, 'kasseV', users)
            tr
              th: .form-control-plaintext Zwei:
              td: +people(veranstaltung, 'kasse', users)
              td: +button(veranstaltung, 'kasse', users)
            tr: td(colspan=3): h5.mb-0 Technik
            tr
              th: .form-control-plaintext Eins:
              td: +people(veranstaltung, 'technikerV', users)
              td: +button(veranstaltung, 'technikerV', users)
            tr
              th: .form-control-plaintext Zwei:
              td: +people(veranstaltung, 'techniker', users)
              td: +button(veranstaltung, 'techniker', users)
            tr: td(colspan=3): h5.mb-0 Master
            tr
              th: .form-control-plaintext &nbsp;
              td: +people(veranstaltung, 'mod', users)
              td: +button(veranstaltung, 'mod', users)
            tr: td(colspan=3)
              button.btn.btn-sm.btn-success.float-right(type='submit'): i(class='fas fa-fw fa-save fa-lg')
  | </div>


block title
  | Veranstaltungen

block content
  .col-12
    .row
      .col-lg-8
        .page-header
          .btn-group.float-right
            a.btn.btn-light(href='/veranstaltungen/new', title='Neu'): i.far.fa-file.fa-fw
            a.btn.btn-light(href=webcalURL, title='als iCal'): i.far.fa-calendar-alt
            .dropdown
              a.btn.btn-light.dropdown-toggle(data-toggle='dropdown')
                | #{titel} &nbsp;
                span.caret
              .dropdown-menu
                a.dropdown-item(href='/veranstaltungen/zukuenftige') Zukünftige
                a.dropdown-item(href='/veranstaltungen/vergangene') Vergangene

          h2 Veranstaltungen
        +zuAufButtons
        +panelView(veranstaltungen)
      .col-lg-4
        +calendar(icals)
            
block head
  link(rel='stylesheet', href='/stylesheets/fullcalendar.css')

block scripts
  script.
    $(document).ready(function () {
      function shirtsizeChanged() {
        $.ajax('/users/tshirt-size-for', {data: {user: this.id, value: this.value}})
      } 
      $('select[name="tshirt"]').change(shirtsizeChanged);
      
      function telChanged() {
        $.ajax('/users/tel-for', {data: {user: this.id, value: this.value}})
      } 
      $('input[name="tel"]').change(telChanged);
    });
  
